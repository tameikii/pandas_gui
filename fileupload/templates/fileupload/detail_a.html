{% load static %}
<!DOCTYPE html>
<html lang='ja', class = 'h-100'>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!--Bootstrapの読み込み-->
    <link rel="stylesheet" href="{% static '/css/bootstrap.min.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- fontawesome-->
    <script src="https://kit.fontawesome.com/f33f3b7f60.js" crossorigin="anonymous"></script>

    <!--staticのcssファイルの読み込み-->
   <!--<link rel="stylesheet" href="{% static '/css/detail.css' %}">-->
    <!--JQueryの読み込み-->
    <script src="http://code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <!--Pysctiptのcssの読み込み-->
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <!--Pysctiptのjsライブラリーを取り込み-->
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <head>
            <title>pandas_GUIもどき</title>
            <style media="screen">
                header{
                    height: 50px;
                    box-shadow: 0px 0px 5px 0px hsla(0, 0%, 7%, 0.3);
                }
                nav {
                    width: 230px;
                }
                .nav-link {
                    color: white;
                    background-color: rgba(255, 255, 255, 0.493);
                }
                main {
                    transition: 0.3s all ease;
                }
                .prime_button{
                    border: none;
                    out_line: none;
                }
                /***** 真ん中のバーガー線 *****/
                .btn-line {
                  /* 線の長さと高さ */
                  width: 100%;
                  height: 4px;
                  /* バーガー線の色 */
                  background-color: #333;
                  /* バーガー線の位置基準として設定 */
                  position: relative;
                  transition: .2s;
                  z-index: 18;
                  display: block; /* 追加 */
                }
                
                /***** 上下のバーガー線 *****/
                .btn-line::before,
                .btn-line::after {
                  content: "";
                  /* 基準線と同じ大きさと色 */
                  position: absolute;
                  width: 100%;
                  height: 100%;
                  background-color: #333;
                  transition: .2s;
                  z-index: 8;
                  display: block; /* 追加 */
                }
            </style>
    </head>
    <py-env>
        - pandas
        - numpy
    </py-env>

    <body>
        <header class="w-100 d-flex justify-content-between align-items-center bg-light px-3">
            <!— ヘッダーの内容 -->
            <h1 class="mx-2 fs-4 text-primary fw-bold">DataFrameの編集</h1>

            <ul class="navbar-nav d-flex flex-row">
                <li class="nav-item mx-3 text-muted active"><a href="#" class="nav-link text-secondary">New</a></li>
                <li class="nav-item mx-3 text-muted"><a href="#" class="nav-link text-secondary">Save</a></li>
                <li class="nav-item mx-3 text-muted">
            </ul>
        </header>
        <div class="d-flex flex-row w-100" style="height: calc(100% - 50px)">
            <!--　サイドメニュ　ー-->
            <nav class ="bg-dark">
                <ul class="nav flex-column m-0 p-3">
                    <li class="nav-item mb-2"><a href="{% url 'fileupload:index' %}" class="nav-link">トップへ</a></li>
                    <li class="nav-item mb-2"><a href="{{ file_value.upload_dir.url }}" class="nav-link">download</a></li>
                    <li class="nav-item mb-2"><a href="{% url 'fileupload:delete' pk=file_value.id %}" class="nav-link">deleate</a></li>
                </ul>
             </nav>
            <!-- メインコンテンツ -->
            <main class="w-100 bg-light">
                <!-- 編集ボタン -->
                <div class="border shadow-sm d-flex flex-row align-items-center bg-light">
                    <div class='navbar-brand toggle-menu'>
                        <button class='btn btn-light btn-sm' id="toggle"><i class="fa-solid fa-bars"></i></button>
                    </div>
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                          <a class="nav-link active" aria-current="page" href="#">Active</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="#">Link</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="#">Link</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
                        </li>
                      </ul>
                </div>
                <!-- コンテンツ --> 
                <div class="p-3">
                    <div class = "container">
                        <div class="ratio ratio-16x9">
                        <iframe src= "{% url 'fileupload:profile' %}" title="DataProfiling" allowfullscreen sandbox scrolling=”auto”></iframe>
                        </div>
                    </div>
                    <br>
                    <div class="d-flex flex-row">
                        <br>
                        <div class = "container">
                            <div style="overflow-y:scroll; overflow-x:scroll; scrollbar-base-color:#99ff66 ; scrollbar-arrow-color:#ff0000;">
                            <div class="row">
                                <table class="table table-striped table-bordered table-hover table-wid" id="dataframe">    
                                    <tr>
                                        <th style="text-align: center"  ></th>
                                        {% for column, item in df.iteritems %}
                                        <th style="text-align: center">{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                    <tbody id="sortable">
                                    {% for index, rows in df.iterrows %}
                                        {% if index <= 10 %}
                                        <tr>
                                            <th style="text-align: center" >{{ index }}</th>
                                            {% for row in rows %}<td>{{ row }}</td>{% endfor %}
                                        </tr>
                                        {% else %}
                                        <tr class="readOnlyRow">
                                            <th style="text-align: center" >{{ index }}</th>
                                            {% for row in rows %}<td>{{ row }}</td>{% endfor %}
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>    
                            </div>
                        </div>
                    </div>
                    
                        <br>
                        <div class = "container">
                            <div style="overflow-y:scroll; overflow-x:scroll; scrollbar-base-color:#99ff66 ; scrollbar-arrow-color:#ff0000;">
                            <div class="row">
                                <table class="table table-striped table-bordered table-hover table-wid" id="dataframe">    
                                    <tr style="text-align: center"  ><th>df-info</th></tr>
                                    {% for info in df_info %}
                                    <tr style="text-align: center"><td>{{ info }}</td></tr>
                                    {% endfor %}               
                                </table>
                            </div>    
                            </div>
                        </div>
                        <br>
                        <div class = "container">
                            <div style="overflow-y:scroll; overflow-x:scroll; scrollbar-base-color:#99ff66 ; scrollbar-arrow-color:#ff0000;">
                            <div class="row">
                                <table class="table table-striped table-bordered table-hover table-wid" id="dataframe">    
                                    <tr>
                                        <th style="text-align: center"  ></th>
                                        {% for column, item in df_describe.iteritems %}
                                        <th style="text-align: center">{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                    {% for index, rows in df_describe.iterrows %}
                                        <tr>
                                            <th style="text-align: center" >{{ index }}</th>
                                            {% for row in rows %}<td>{{ row }}</td>{% endfor %}
                                        </tr>                    
                                    {% endfor %}                                    
                                </table>
                            </div>    
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-row">
                            <div id="data-info"></div>
                            <div id="data-describe"></div>
                    </div>
                </div>
            </main>
        </div>
    </body>

    <script type="text/javascript">
        //columnsの先頭が空白なことに注意
        flag = 0
        table_columns = new Array()
        table_data = new Array()
        table = document.getElementById('dataframe')
        for (let row of table.rows) {
            if(flag == 0){
                for(let cell of row.cells){
                    table_columns.push(cell.innerText)
                 }
                 flag = 1
            }
            else{
                df_rows = new Array()
                for(let cell of row.cells){
                   df_rows.push(cell.innerText)
                }
                table_data.push(df_rows)
            }
        }
        length_table = table_data.length
        length_columns = table_columns.length
    </script>
    <script type="text/javascript">
        window.onload = () => {
            // toggleボタン
            let sidemenuToggle = document.getElementById('toggle')
            // メインコンテンツを囲むmain要素
            let page = document.getElementsByTagName('main')[0];
            // 表示状態 trueで表示中 falseで非表示
            let sidemenuStatus = true;
            // ボタンクリック時のイベント
            sidemenuToggle.addEventListener('click', () => {
                // 表示状態を判定
                if(sidemenuStatus){
                    page.style.cssText = 'margin-left: -230px'
                    sidemenuStatus = false;
                }else{
                    page.style.cssText = 'margin-left: 0px'
                    sidemenuStatus = true;
                }
            })
        }
    </script>
    <!--表をドラックで並び替えるようにするコード-->
    <script>
        $('#sortable').sortable({
            //updateで並べ替えるたびに更新
            update: function(){
                $("#log").text($('#sortable').sortable("toArray"))
            }
        });
        $('#sortable').disableSelection();
        $('#sortable').bind('sortstop', function (e, ui) {
            // ソートが完了したら実行される。
            var rows = $('#sortable .rank');
            for (var i = 0, rowTotal = rows.length; i < rowTotal; i += 1) {
                $($('.rank')[i]).text(i + 1);
            }
        })
    </script>
    <script  type="text/javascript">
        //javascript
        $(document).ready(function() {
            $(".readOnlyRow").hide();
            $("#readOnlyRowsToggle").click(function() {
             var elem = $(".readOnlyRow")[0];
             if(elem.style.display == 'none')
              $(".readOnlyRow").show();
             else
              $(".readOnlyRow").hide();
            });
           });
    </script>
    <script src="{% static '/js/jquery-3.6.1.min.js' %}"></script>
    <script src="{% static '/js/bootstrap.bundle.min.js' %}"></script> 
     <!--info button-->
    

     <script type="text/javascript">
        //表示ボタンの２度押しを防止する処理]
        const info = document.getElementById("info-button")
        info.addEventListener("click", () => {
            info.disabled = true;
            //console.log(`${diplay_info}`);
        });
           
        const describe = document.getElementById("describe-button")
        describe.addEventListener("click", () => {
            describe.disabled = true;
            //console.log(`${diplay_describe}`);
        });
    </script>
    <!--読み込みを行う順番の関係-->
    <script>

        //pyscriptとjavascriptで変数を共有するための関数
        function createObject(object, variableName){
            //Bind a variable whose name is the string variableName
            // to the object called 'object'
            let execString = variableName + " = object"
            console.log("Running `" + execString + "`");
            eval(execString)
        }
    </script>
    <py-script>
import pandas as pd
import numpy as np
from js import createObject, table_data, table_columns,length_table, length_columns
from pyodide.ffi import create_proxy
createObject(create_proxy(globals()), "pyodideGlobals")

#dataFrameを作成するための処理

df_types  = list()
{% for type in df_type_list %}
df_types.append("{{type}}")
{% endfor %}

dataframe = np.array([[table_data[i][j] for j in range(int(length_columns))] for i in range(length_table)])
df = pd.DataFrame(dataframe,columns=table_columns)
df = df[df.columns[1:]]
df_prime = df
dtype_dict = {key: val for key, val in zip(df.columns, df_types)}
df = df.astype(dtype_dict)
    </py-script>
</html>

